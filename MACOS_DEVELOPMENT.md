# üçé macOS Development Guide

Since eBPF requires the Linux kernel, you **cannot compile or run the eBPF agent natively on macOS**. However, you can still develop and test components of the project.

## ‚ö†Ô∏è Limitations on macOS

**Won't Work:**
- ‚úó Compiling eBPF C code (requires Linux kernel headers)
- ‚úó Running the eBPF agent locally
- ‚úó Attaching uprobes to processes
- ‚úó Direct `make build` or `make generate`

**Will Work:**
- ‚úì Developing Go code (agent logic)
- ‚úì Testing NATS integration
- ‚úì Building Docker images (uses Linux container)
- ‚úì Running the NATS subscriber
- ‚úì Deploying to remote Linux environments

## üöÄ Quick Start on macOS

### 1. Check Your Environment

```bash
make check-env
```

This will confirm you're on macOS and show available options.

### 2. Install Dependencies

```bash
# Already done if you ran:
brew install llvm go

# Download Go dependencies
make deps

# Install bpf2go (for reference, won't work without Linux)
make tools
```

### 3. Test NATS Integration

```bash
# Terminal 1: Start NATS server
docker run -d --name nats-dev -p 4222:4222 -p 8222:8222 nats:latest

# Terminal 2: Run the subscriber
make test-subscriber
# Or manually:
# go run nats_subscriber_example.go

# You can manually publish test messages to verify:
docker exec -it nats-dev nats pub "test-app.jsonrpc.response-size" '{"app_id":"test","value":1234}'
```

### 4. Build Docker Image (Recommended)

The Docker build uses a Linux container, so it will work on macOS:

```bash
# Build the agent in a Linux container
make docker-build

# This creates: ebpf-agent:latest
```

### 5. Deploy to Linux Environment

Once built, you can:

**Option A: Deploy to Kubernetes**
```bash
# Push to your container registry
docker tag ebpf-agent:latest your-registry/ebpf-agent:latest
docker push your-registry/ebpf-agent:latest

# Update k8s-deployment.yaml with your image
# Then deploy:
kubectl apply -f k8s-deployment.yaml
```

**Option B: Run on a Linux VM**
```bash
# Copy files to Linux machine
scp -r . user@linux-host:/path/to/ebpf_agent_poc

# SSH into Linux machine
ssh user@linux-host

# Build and run
cd /path/to/ebpf_agent_poc
make build
sudo ./ebpf-agent
```

**Option C: Use Multipass (Ubuntu VM on macOS)**
```bash
# Install Multipass
brew install multipass

# Create Ubuntu VM
multipass launch --name ebpf-dev --cpus 2 --memory 4G --disk 20G

# Mount your project
multipass mount . ebpf-dev:/home/ubuntu/ebpf_agent_poc

# Enter VM
multipass shell ebpf-dev

# Inside VM:
cd ~/ebpf_agent_poc
sudo apt update
sudo apt install -y clang llvm golang make libbpf-dev linux-headers-$(uname -r)
make build
sudo ./ebpf-agent
```

## üß™ Testing Workflow on macOS

### Development Loop

1. **Edit Go Code** on macOS (use any IDE/editor)
2. **Test Compilation** (will fail at eBPF parts, that's OK):
   ```bash
   go build -o /dev/null agent_main.go 2>&1 | grep -v "rpcObjects\|loadRpcObjects"
   ```
3. **Test NATS Logic** with subscriber:
   ```bash
   make test-subscriber
   ```
4. **Build in Docker** when ready:
   ```bash
   make docker-build
   ```
5. **Deploy to Linux** for real testing

### Manual Testing with NATS

```bash
# Start NATS
docker run -d --name nats-dev -p 4222:4222 nats:latest

# Subscribe to all messages
go run nats_subscriber_example.go

# In another terminal, publish test messages:
# Install NATS CLI (optional)
go install github.com/nats-io/natscli/nats@latest

# Publish test event
nats pub "arbitrum-node.jsonrpc.response-size" \
  '{"app_id":"arbitrum-node","protocol":"jsonrpc","feature_type":"response-size","timestamp":"2024-10-23T12:00:00Z","value":2048,"context_hash":"method:eth_call","details":{"method":"eth_call"}}'
```

## üê≥ Docker Development

Since Docker uses Linux containers, you can build everything in Docker:

```bash
# Build the image (includes eBPF compilation)
make docker-build

# The Dockerfile uses multi-stage build:
# 1. Builder stage: Ubuntu with build tools
# 2. Compiles eBPF C code to bytecode
# 3. Builds Go agent
# 4. Runtime stage: Minimal Ubuntu with just the binary

# View the image
docker images | grep ebpf-agent
```

## üîç Understanding the Errors

### Expected Errors on macOS:

**1. "fatal error: 'linux/bpf.h' file not found"**
- **Why**: Linux kernel headers don't exist on macOS
- **Solution**: Use Docker to build

**2. "undefined: rpcObjects"**
- **Why**: `rpcObjects` is generated by `go generate` (bpf2go), which requires Linux
- **Solution**: Ignore in IDE, or use Docker

**3. IDE showing "MonitoringFeature redeclared"**
- **Why**: Two `main` packages in same directory (agent + subscriber)
- **Solution**: Ignore - they're separate programs

## üìù IDE Setup Tips

### VS Code

Add to `.vscode/settings.json`:
```json
{
  "go.buildTags": "ignore",
  "go.lintFlags": ["--build-tags=ignore"],
  "files.exclude": {
    "**/*_bpf*.go": true,
    "**/*_bpf*.o": true
  }
}
```

### GoLand / IntelliJ

- Mark `agent_main.go` and `nats_subscriber_example.go` as separate build scopes
- Exclude generated `*_bpf*.go` files from indexing

## üéØ Recommended Workflow

**For macOS-only development:**
1. Develop and test Go logic locally
2. Use `make test-subscriber` to test NATS
3. Build with `make docker-build`
4. Deploy to remote Linux for integration testing

**For serious eBPF development:**
1. Use a Linux VM (Multipass, UTM, Parallels)
2. Or use a remote Linux dev server
3. Or use VS Code Remote-SSH to a Linux machine

## üìö Additional Resources

- [eBPF Documentation](https://ebpf.io/)
- [Multipass Documentation](https://multipass.run/docs)
- [Docker Multi-platform Builds](https://docs.docker.com/build/building/multi-platform/)

## ‚ö° Quick Reference

```bash
# What works on macOS:
make deps              # ‚úì Download dependencies
make tools             # ‚úì Install bpf2go
make check-env         # ‚úì Check environment
make test-subscriber   # ‚úì Test NATS
make docker-build      # ‚úì Build in container
make clean             # ‚úì Clean files

# What requires Linux:
make generate          # ‚úó Needs Linux headers
make build             # ‚úó Depends on generate
make run               # ‚úó Needs Linux kernel
```

---

**Bottom Line**: Use Docker for building, deploy to Linux for running. macOS is fine for editing code and testing NATS integration.
