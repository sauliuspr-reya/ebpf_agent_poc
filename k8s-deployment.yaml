---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ebpf-agent-config
  namespace: nats
data:
  NATS_URL: "nats://nats.nats.svc.cluster.local:4222"
  APP_ID: "testnet-rpc-monitor"
  # Kernel-level network tracing (captures ALL TCP traffic from Node.js)
  # No TARGET_BINARY/TARGET_SYMBOL needed - uses kprobes on tcp_sendmsg
  DEBUG: "true"  # Enable verbose debug logging

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ebpf-agent
  namespace: nats
  labels:
    app: ebpf-agent
spec:
  selector:
    matchLabels:
      app: ebpf-agent
  template:
    metadata:
      labels:
        app: ebpf-agent
    spec:
      hostPID: true
      # hostNetwork: true  # Disabled to allow cluster DNS resolution
      serviceAccountName: ebpf-agent
      # Allow running on spot nodes (where oracle pods run)
      tolerations:
      - key: cloud.google.com/gke-spot
        operator: Equal
        value: "true"
        effect: NoSchedule
      containers:
      - name: ebpf-agent
        # Update this to your GCR image: gcr.io/testnet-473109/ebpf-agent:latest
        image: gcr.io/testnet-473109/ebpf-agent:latest
        imagePullPolicy: Always
        securityContext:
          privileged: true
          capabilities:
            add:
              - SYS_ADMIN
              - SYS_RESOURCE
              - NET_ADMIN
              - BPF
        envFrom:
        - configMapRef:
            name: ebpf-agent-config
        volumeMounts:
        - name: sys-kernel-debug
          mountPath: /sys/kernel/debug
          readOnly: true
        - name: proc
          mountPath: /host/proc
          readOnly: true
        - name: sys-fs-bpf
          mountPath: /sys/fs/bpf
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"
      volumes:
      - name: sys-kernel-debug
        hostPath:
          path: /sys/kernel/debug
          type: Directory
      - name: proc
        hostPath:
          path: /proc
          type: Directory
      - name: sys-fs-bpf
        hostPath:
          path: /sys/fs/bpf
          type: DirectoryOrCreate

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ebpf-agent
  namespace: nats

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ebpf-agent
rules:
- apiGroups: [""]
  resources: ["nodes", "pods"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ebpf-agent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ebpf-agent
subjects:
- kind: ServiceAccount
  name: ebpf-agent
  namespace: nats
